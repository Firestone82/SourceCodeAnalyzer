<div class="flex flex-col gap-4">
  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <div nz-typography nzType="secondary">Submits</div>
        <div nz-typography>Upload new source bundles or review existing submits.</div>
      </div>

      <button (click)="openUploadModal()" nz-button nzType="primary">Upload submit</button>
    </div>

    @if (errorMessage) {
      <div class="mt-3" nz-typography nzType="danger">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="mb-4 flex flex-wrap items-center gap-3">
      <input
        (keyup.enter)="applyFilters()"
        [(ngModel)]="modelFilter"
        class="max-w-[240px]"
        nz-input
        placeholder="Filter by model"
      />

      <input
        (keyup.enter)="applyFilters()"
        [(ngModel)]="promptFilter"
        class="max-w-[240px]"
        nz-input
        placeholder="Filter by prompt path"
      />

      <input
        (keyup.enter)="applyFilters()"
        [(ngModel)]="sourceFilter"
        class="max-w-[240px]"
        nz-input
        placeholder="Filter by source path"
      />

      <label (ngModelChange)="applyFilters()" [(ngModel)]="onlyUnrated" nz-checkbox>
        Only not rated
      </label>
    </div>

    <nz-table
      (nzPageIndexChange)="onPageIndexChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzData]="submits"
      [nzFrontPagination]="false"
      [nzLoading]="isLoading"
      [nzPageIndex]="pageIndex"
      [nzPageSizeOptions]="[10, 20, 50]"
      [nzPageSize]="pageSize"
      [nzScroll]="{ y: '480px' }"
      [nzShowSizeChanger]="true"
      [nzTotal]="totalSubmits"
      class="submits-table"
      nzBordered
      nzSize="small"
    >
      <thead>
      <tr>
        <th nzWidth="50px">Id</th>
        <th>Model</th>
        <th>Prompt path</th>
        <th>Source path</th>
        <th>Submit date</th>
        <th nzWidth="100px">Visibility</th>
        <th nzWidth="80px">Rated</th>
        <th nzWidth="100px">Total issues</th>
        <th></th>
      </tr>
      </thead>

      <tbody>
        @for (submit of submits; track $index) {
          <tr>
            <td class="col-min">{{ submit.id }}</td>
            <td>{{ submit.model }}</td>
            <td>
              <a
                [queryParams]="{prompt: submit.prompt_path}"
                [routerLink]="['/prompts']"
                class="text-blue-600 hover:text-blue-500"
              >
                {{ submit.prompt_path }}
              </a>
            </td>
            <td>
              <a
                [queryParams]="{source: submit.source_path}"
                [routerLink]="['/sources']"
                class="text-blue-600 hover:text-blue-500"
              >
                {{ submit.source_path }}
              </a>
            </td>
            <td>{{ submit.created_at | date:'yyyy-MM-dd HH:mm:ss' }}</td>
            <td class="text-center m-0">
              <nz-tag [nzColor]="submit.published ? 'green' : 'gold'">
                {{ submit.published ? 'Published' : 'Testing' }}
              </nz-tag>
            </td>
            <td class="text-center m-0">
              <nz-tag [nzColor]="submit.rated ? 'green' : 'red'">
                {{ submit.rated ? 'Yes' : 'No' }}
              </nz-tag>
            </td>
            <td class="text-center">{{ submit.total_issues }}</td>
            <td class="text-center">
              <div class="flex w-full flex-row gap-2">
                <a
                  (click)="handleRateClick($event, submit)"
                  [routerLink]="['/submits', submit.id]"
                  class="w-full"
                  nz-button
                  nzType="primary"
                >
                  Rate
                </a>

                @if (isAdmin) {
                  <button
                    (click)="togglePublish(submit)"
                    [disabled]="publishingSubmitIds.has(submit.id)"
                    class="w-full"
                    nz-button
                    nzType="default"
                  >
                    {{ submit.published ? 'Unpublish' : 'Publish' }}
                  </button>
                }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </nz-table>
  </nz-card>
</div>

<app-submit-upload-modal
  (isVisibleChange)="isUploadModalVisible = $event"
  (uploadComplete)="handleUploadCompleted($event)"
  [isVisible]="isUploadModalVisible"
/>

<app-job-created-modal
  (isVisibleChange)="isJobModalVisible = $event"
  [isVisible]="isJobModalVisible"
  [jobIds]="jobModalIds"
/>
