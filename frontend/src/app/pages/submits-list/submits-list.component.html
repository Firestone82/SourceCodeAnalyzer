<div class="flex flex-col gap-4">
  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <div nz-typography nzType="secondary">Submits</div>
        <div nz-typography>Upload new source bundles or review existing submits.</div>
      </div>

      @if (isAdmin) {
        <button (click)="openUploadModal()" nz-button nzType="primary">Upload submit</button>
      }
    </div>

    @if (errorMessage) {
      <div class="mt-3" nz-typography nzType="danger">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="mb-4 flex flex-col gap-3">
      @if (isAdmin) {
        <div class="flex flex-wrap items-center gap-2">
          <input
            [(ngModel)]="massReanalyzePromptPath"
            [nzAutocomplete]="promptPathAutoComplete"
            class="max-w-[320px]"
            nz-input
            placeholder="Prompt path for reevaluation"
          />

          <button
            (click)="massReanalyzeWithPrompt()"
            [disabled]="selectedSubmitsCount === 0 || !massReanalyzePromptPath.trim() || isMassReanalyzing || isMassPublishing || isMassDeleting"
            nz-button
            nzSize="small"
            nzType="primary"
          >
            Reevaluate selected
          </button>

          <button
            (click)="massSetPublishState(true)"
            [disabled]="selectedSubmitsCount === 0 || isMassPublishing || isMassDeleting || isMassReanalyzing"
            nz-button
            nzSize="small"
            nzType="default"
          >
            Publish selected
          </button>

          <button
            (click)="massSetPublishState(false)"
            [disabled]="selectedSubmitsCount === 0 || isMassPublishing || isMassDeleting || isMassReanalyzing"
            nz-button
            nzSize="small"
            nzType="default"
          >
            Unpublish selected
          </button>

          <button
            (click)="massDeleteSubmits()"
            [disabled]="selectedSubmitsCount === 0 || isMassDeleting || isMassPublishing || isMassReanalyzing"
            nz-button
            nzDanger
            nzSize="small"
            nzType="default"
          >
            Delete selected
          </button>
        </div>
      }

      <div class="flex flex-wrap items-center gap-2">
        <input
          (keyup.enter)="applyFilters()"
          [(ngModel)]="modelFilter"
          class="max-w-[240px]"
          nz-input
          placeholder="Filter by model"
        />

        <input
          (keyup.enter)="applyFilters()"
          [(ngModel)]="promptFilter"
          class="max-w-[240px]"
          nz-input
          placeholder="Filter by prompt path"
        />

        <input
          (keyup.enter)="applyFilters()"
          [(ngModel)]="sourceFilter"
          class="max-w-[240px]"
          nz-input
          placeholder="Filter by source path"
        />


        <input
          (keyup.enter)="applyFilters()"
          [(ngModel)]="sourceTagFilter"
          class="max-w-[220px]"
          nz-input
          placeholder="Filter by source tag"
        />

        <label (ngModelChange)="applyFilters()" [(ngModel)]="onlyUnrated" nz-checkbox>
          Only not rated
        </label>

        <label (ngModelChange)="handleRandomizedNavigationChange($event)" [(ngModel)]="isRandomizedNavigation" nz-checkbox>
          Randomize submits table
        </label>
      </div>
    </div>

    <nz-table
      (nzPageIndexChange)="onPageIndexChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzData]="submits"
      [nzFrontPagination]="false"
      [nzLoading]="isLoading"
      [nzPageIndex]="pageIndex"
      [nzPageSizeOptions]="[10, 20, 50]"
      [nzPageSize]="pageSize"
      [nzScroll]="{ y: '480px' }"
      [nzShowSizeChanger]="true"
      [nzTotal]="totalSubmits"
      class="submits-table"
      nzBordered
      nzSize="small"
    >
      <thead>
      <tr>
        <th nzWidth="44px" nzAlign="center">
          <label
            (ngModelChange)="toggleSelectAllOnPage($event)"
            [ngModel]="isAllOnPageSelected"
            [nzIndeterminate]="isPartiallySelectedOnPage"
            nz-checkbox
          ></label>
        </th>
        <th nzWidth="40px">Id</th>
        <th nzWidth="150px">Model</th>
        <th>Prompt path</th>
        <th>Source path</th>
        <th nzWidth="150px">Source tag</th>
        @if (isAdmin) {
          <th nzWidth="80px" nzAlign="center">Visibility</th>
        }
        <th nzWidth="140px" nzAlign="center">Rating status</th>
        <th nzWidth="60px" nzAlign="center">Issues</th>
        <th nzWidth="200px"></th>
      </tr>
      </thead>

      <tbody>
        @for (submit of submits; track $index) {
          <tr>
            <td class="text-center">
              <label
                (ngModelChange)="toggleSubmitSelection(submit.id, $event)"
                [ngModel]="selectedSubmitIds.has(submit.id)"
                nz-checkbox
              ></label>
            </td>

            <td class="col-min">
              <code>{{ submit.id }}</code>
            </td>

            <td>{{ submit.model }}</td>

            <td class="whitespace-normal break-all">
              <a
                [queryParams]="{prompt: submit.prompt_path}"
                [routerLink]="['/prompts']"
                class="text-blue-600 hover:text-blue-500"
              >
                {{ submit.prompt_path }}
              </a>
            </td>

            <td class="whitespace-normal break-all">
              <a
                [queryParams]="{source: submit.source_path}"
                [routerLink]="['/sources']"
                class="text-blue-600 hover:text-blue-500"
              >
                {{ submit.source_path }}
              </a>
            </td>

            <td class="text-center m-0">
              @if (submit.source_tag) {
                <nz-tag [nzColor]="sourceTagColor(submit.source_tag)">{{ submit.source_tag }}</nz-tag>
              } @else {
                <span>-</span>
              }
            </td>

            @if (isAdmin) {
              <td class="text-center m-0">
                <nz-tag [nzColor]="submit.published ? 'green' : 'gold'">
                  {{ submit.published ? 'Published' : 'Testing' }}
                </nz-tag>
              </td>
            }

            <td class="text-center m-0">
              <nz-tag [nzColor]="ratingStateColor(submit.rating_state)">
                {{ ratingStateLabel(submit.rating_state) }}
              </nz-tag>
            </td>

            <td class="text-center">{{ submit.total_issues }}</td>

            <td class="text-center">
              <div class="flex w-full flex-row gap-2">
                <a
                  (click)="handleRateClick($event, submit)"
                  [routerLink]="['/submits', submit.id]"
                  class="w-full"
                  nz-button
                  nzSize="small"
                  nzType="primary"
                >
                  Rate
                </a>

                @if (isAdmin) {
                  <button
                    (click)="togglePublish(submit)"
                    [disabled]="publishingSubmitIds.has(submit.id) || deletingSubmitIds.has(submit.id)"
                    class="w-full"
                    nz-button
                    nzSize="small"
                    nzType="default"
                  >
                    {{ submit.published ? 'Unpublish' : 'Publish' }}
                  </button>

                  <button
                    (click)="deleteSubmit(submit)"
                    [disabled]="deletingSubmitIds.has(submit.id) || publishingSubmitIds.has(submit.id)"
                    class="w-full"
                    nz-button
                    nzDanger
                    nzSize="small"
                    nzType="default"
                  >
                    <nz-icon nzType="delete" nzTheme="outline" class="px-1"/>
                  </button>
                }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </nz-table>

    <nz-autocomplete #promptPathAutoComplete>
      @for (path of availablePromptPaths; track path) {
        <nz-auto-option [nzValue]="path">{{ path }}</nz-auto-option>
      }
    </nz-autocomplete>
  </nz-card>
</div>

<app-submit-upload-modal
  (isVisibleChange)="isUploadModalVisible = $event"
  (uploadComplete)="handleUploadCompleted($event)"
  [isVisible]="isUploadModalVisible"
/>

<app-job-created-modal
  (isVisibleChange)="isJobModalVisible = $event"
  [isVisible]="isJobModalVisible"
  [jobIds]="jobModalIds"
/>
