<div class="flex flex-col gap-4">
  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <div nz-typography nzType="secondary">Jobs</div>
        <div nz-typography>Track running and completed analysis jobs.</div>
      </div>
    </div>
  </nz-card>

  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="mb-4 flex flex-wrap items-center gap-3">
      <nz-select
        (ngModelChange)="statusFilter = $event; applyFilters()"
        [ngModel]="statusFilter"
        class="w-[200px]"
        nzAllowClear
        nzPlaceHolder="All statuses"
      >
        <nz-option nzLabel="Running" nzValue="running"></nz-option>
        <nz-option nzLabel="Succeeded" nzValue="succeeded"></nz-option>
        <nz-option nzLabel="Failed" nzValue="failed"></nz-option>
      </nz-select>
    </div>

    <nz-table
      (nzPageIndexChange)="onPageIndexChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzData]="jobs"
      [nzFrontPagination]="false"
      [nzLoading]="isLoading"
      [nzPageIndex]="pageIndex"
      [nzPageSizeOptions]="[10, 20, 50]"
      [nzPageSize]="pageSize"
      [nzShowSizeChanger]="true"
      [nzTotal]="totalJobs"
      class="jobs-table"
      nzBordered
      nzSize="small"
    >
      <thead>
      <tr>
        <th class="w-[120px]">Job ID</th>
        <th>Model</th>
        <th>Prompt path</th>
        <th>Source path</th>
        <th class="w-[170px]">Updated</th>
        <th class="w-[120px] text-center">Status</th>
        <th class="w-[120px]">Submit</th>
      </tr>
      </thead>
      <tbody>
        @for (job of jobs; track job.id) {
          <tr class="text-xs">
            <td class="whitespace-nowrap py-1">
              <span [title]="job.job_id">{{ shortJobId(job.job_id) }}</span>
            </td>

            <td [title]="job.model || '-'" class="truncate max-w-[160px] py-1">
              {{ job.model || '-' }}
            </td>

            <td [title]="job.prompt_path || '-'" class="truncate max-w-[200px] py-1">
              {{ job.prompt_path || '-' }}
            </td>

            <td [title]="job.source_path || '-'" class="truncate max-w-[200px] py-1">
              {{ job.source_path || '-' }}
            </td>

            <td class="py-1">
              {{ job.updated_at | date:'yyyy-MM-dd HH:mm:ss' }}
            </td>

            <td class="text-center py-1">
              <nz-tag [nzColor]="statusColor(job.status)">
                {{ job.status }}
              </nz-tag>
            </td>

            <td class="py-1">
              @if (job.status === 'failed') {
                <button (click)="openErrorLog(job)" nz-button nzSize="small" nzType="default" nzDanger>
                  View error log
                </button>
              } @else if (job.submit_id) {
                <button [routerLink]="['/submits', job.submit_id]" nz-button nzSize="small" nzType="default">
                  Show submit
                </button>
              } @else {
                <span>-</span>
              }
            </td>
          </tr>
        }
      </tbody>
    </nz-table>
  </nz-card>
</div>

<nz-modal
  (nzOnCancel)="closeErrorLogModal()"
  (nzOnOk)="closeErrorLogModal()"
  [nzCancelText]="null"
  [nzClosable]="true"
  [nzFooter]="modalFooter"
  [nzMaskClosable]="false"
  [nzOkText]="'Close'"
  [nzTitle]="'Worker error log'"
  [(nzVisible)]="isErrorLogModalVisible"
  [nzWidth]="'70vw'"
>
  <ng-container *nzModalContent>
    <pre class="max-h-[72vh] overflow-auto whitespace-pre-wrap rounded bg-[#111827] p-4 text-xs text-[#e5e7eb]">{{ (selectedErrorLogText || 'No error log available.').replaceAll('\\n', '\n') }}    </pre>
  </ng-container>

  <ng-template #modalFooter>
    <div class="flex items-center justify-end gap-2">
      <button (click)="closeErrorLogModal()" nz-button nzType="primary">Close</button>
    </div>
  </ng-template>
</nz-modal>
