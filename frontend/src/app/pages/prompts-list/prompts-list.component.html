<div class="flex flex-col gap-4">
  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="flex items-center justify-between">
      <div>
        <div nz-typography nzType="secondary">Prompts Viewer</div>
        <div nz-typography>Browse prompt sources and preview their raw or markdown content.</div>
      </div>

      <div class="flex gap-2">
        @if (isAdmin) {
          <button
            (click)="openEditModal()"
            [disabled]="!selectedPromptPath"
            nz-button
            nzType="default"
          >
            Edit prompt
          </button>
        }
        <button
          (click)="openReviewModal()"
          nz-button
          nzType="primary"
        >
          Start review
        </button>
      </div>
    </div>

    @if (errorMessage) {
      <div class="mt-3" nz-typography nzType="danger">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-spin [nzSpinning]="isLoading" nzTip="Loading...">
    <div class="grid grid-cols-[minmax(220px,1fr)_minmax(0,4fr)] gap-4">
      <div>
        <nz-card class="prompt-tree-container">
          <div nz-typography nzType="secondary">Found sources</div>

          <nz-tree
            (nzClick)="handlePromptNodeClick($event)"
            [nzData]="promptTreeNodes"
            [nzSelectedKeys]="selectedPromptKeys"
            [nzTreeTemplate]="promptTreeNodeTemplate"
            nzBlockNode
            nzExpandAll
            nzShowLine
            nzVirtualHeight="60vh"
          ></nz-tree>
          <ng-template #promptTreeNodeTemplate let-node>
            <span>{{ node.title }}</span>
          </ng-template>
        </nz-card>
      </div>

      <div>
        <nz-card>
          <div>
            <div nz-typography nzType="secondary">Prompt content</div>
          </div>

          @if (!selectedPromptPath) {
            <div nz-typography>Select a source from the list to load its content.</div>
          } @else {
            <nz-spin [nzSpinning]="isPromptLoading" nzTip="Loading prompt...">
              @if (promptErrorMessage) {
                <div nz-typography nzType="danger">{{ promptErrorMessage }}</div>
              } @else {
                <div class="mb-3 flex items-center justify-between">

                  <nz-segmented
                    (ngModelChange)="onPromptViewChange($event)"
                    [(ngModel)]="promptViewMode"
                    [nzOptions]="promptViewOptions"
                  ></nz-segmented>
                </div>

                @if (isMarkdownView) {
                  <nz-spin [nzSpinning]="isMarkdownRendering" nzTip="Rendering markdown...">
                    <div [innerHTML]="renderedContent"
                         class="markdown-content rounded-md border border-slate-200 bg-slate-50 p-4 text-sm"
                    ></div>
                  </nz-spin>
                } @else {
                  <pre
                    class="whitespace-pre-wrap break-words rounded-md border border-slate-200 bg-slate-50 p-4 text-sm">{{ content }}</pre>
                }
              }
            </nz-spin>
          }
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<nz-modal
  (nzOnCancel)="closeEditModal()"
  [nzWidth]="'80vw'"
  (nzOnOk)="savePromptChanges()"
  [nzCancelDisabled]="isSavingPrompt || isDeletingPrompt"
  [nzOkLoading]="isSavingPrompt"
  [nzOkDisabled]="isDeletingPrompt"
  [nzVisible]="isEditModalVisible"
  nzCancelText="Cancel"
  nzOkText="Save prompt"
  nzTitle="Edit prompt"
>
  <ng-container *nzModalContent>
    <div class="flex flex-col gap-3">
      <textarea
        [(ngModel)]="editableContent"
        [disabled]="isSavingPrompt || isDeletingPrompt"
        class="min-h-[60vh]"
        nz-input
        placeholder="Edit prompt content"
      ></textarea>

      <button
        (click)="deletePrompt()"
        [disabled]="isSavingPrompt || isDeletingPrompt"
        nz-button
        nzDanger
        nzType="default"
      >
        Delete prompt
      </button>
    </div>
  </ng-container>
</nz-modal>

<app-prompt-review-modal
  (isVisibleChange)="isReviewModalVisible = $event"
  (reviewsQueued)="handleReviewsQueued($event)"
  [isVisible]="isReviewModalVisible"
  [selectedPromptPath]="selectedPromptPath"
/>

<app-job-created-modal
  (isVisibleChange)="isJobModalVisible = $event"
  [isVisible]="isJobModalVisible"
  [jobIds]="jobModalIds"
/>
