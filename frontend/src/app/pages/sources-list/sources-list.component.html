<div class="flex flex-col gap-4">
  <nz-card nzSize="small" class="ml-[5px] w-full max-w-none rounded-[10px]">
    <div class="flex items-center justify-between">
      <div>
        <div nz-typography nzType="secondary">Source Viewer</div>
        <div nz-typography>Browse uploaded sources and start reviews.</div>
      </div>

      <button nz-button
              nzType="primary"
              (click)="openReviewModal()"
      >
        Start review
      </button>
    </div>

    @if (errorMessage) {
      <div nz-typography nzType="danger" class="mt-3">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-spin [nzSpinning]="isLoading" nzTip="Loading...">
    <div class="grid grid-cols-8 gap-4">
      <div class="col-span-2">
        <nz-card class="source-tree-container">
          <div nz-typography nzType="secondary">Found sources</div>

          <nz-tree
            [nzData]="sourceTreeNodes"
            [nzSelectedKeys]="selectedSourceKeys"
            [nzTreeTemplate]="sourceTreeNodeTemplate"
            nzBlockNode
            nzShowLine
            nzVirtualHeight="60vh"
            (nzClick)="handleSourceNodeClick($event)"
          ></nz-tree>
          <ng-template #sourceTreeNodeTemplate let-node>
            <span>{{ node.title }}</span>
            @if (node.isLeaf && node.key === selectedSourcePath) {
              <span class="ml-2 rounded bg-emerald-50 px-1.5 py-0.5 text-[10px] font-semibold text-emerald-700">
                Selected
              </span>
            }
          </ng-template>
        </nz-card>
      </div>

      <div class="col-span-6">
        <nz-card>
          @if (!selectedSourcePath) {
            <div nz-typography>No content is viewed.</div>
          } @else {
            <nz-spin [nzSpinning]="isSourceLoading" nzTip="Loading source...">
              @if (sourceErrorMessage) {
                <div nz-typography nzType="danger">{{ sourceErrorMessage }}</div>
              } @else {
                @if (fileNames.length === 0) {
                  <div nz-typography>No files available for this source.</div>
                } @else {
                  <nz-tabs
                    [nzSelectedIndex]="selectedFileIndex"
                    (nzSelectedIndexChange)="onFileTabChange($event)"
                    nzSize="small"
                  >
                    @for (fileName of fileNames; track fileName) {
                      <nz-tab [nzTitle]="fileName"></nz-tab>
                    }
                  </nz-tabs>

                  @if (selectedFileName) {
                    <app-file-viewer
                      [fileName]="selectedFileName"
                      [fileContent]="selectedFileContent"
                      [issues]="[]"
                    />
                  }
                }
              }
            </nz-spin>
          }
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<app-source-review-modal
  [isVisible]="isReviewModalVisible"
  (isVisibleChange)="isReviewModalVisible = $event"
  [selectedSourcePath]="selectedSourcePath"
  (reviewQueued)="handleReviewQueued($event)"
/>

<app-job-created-modal
  [isVisible]="isJobModalVisible"
  (isVisibleChange)="isJobModalVisible = $event"
  [jobIds]="jobModalIds"
/>
