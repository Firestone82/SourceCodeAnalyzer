<div class="flex flex-col gap-4">
  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="flex items-center justify-between">
      <div>
        <div nz-typography nzType="secondary">Source Viewer</div>
        <div nz-typography>Browse uploaded sources and start reviews.</div>
      </div>

      @if (isAdmin) {
        <button (click)="openReviewModal()"
                nz-button
                nzType="primary"
        >
          Start review
        </button>
      }
    </div>

    @if (errorMessage) {
      <div class="mt-3" nz-typography nzType="danger">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-spin [nzSpinning]="isLoading" nzTip="Loading...">
    <div class="grid grid-cols-[minmax(220px,1fr)_minmax(0,4fr)] gap-4">
      <div>
        <nz-card class="source-tree-container">
          <div nz-typography nzType="secondary">Found sources</div>

          <div class="source-tree-scroll">
            <app-source-tree-selector
              (errorChange)="handleSourceTreeError($event)"
              (loadingChange)="handleSourceTreeLoading($event)"
              (selectedKeysChange)="handleSelectedSourceKeysChange($event)"
              (sourceSelected)="handleSourceSelection($event)"
              [showTags]="true"
              [selectedKeys]="selectedSourceKeys"
            />
          </div>
        </nz-card>
      </div>

      <div>
        <nz-card>
          <div>
            <div nz-typography nzType="secondary">Source content</div>
          </div>

          @if (!selectedSourcePath) {
            <div nz-typography>Select prompt from the list to load its content.</div>
          } @else {
            <nz-spin [nzSpinning]="isSourceLoading" nzTip="Loading source...">
              @if (sourceErrorMessage) {
                <div nz-typography nzType="danger">{{ sourceErrorMessage }}</div>
              } @else {

                @if (isAdmin) {
                  <div class="mb-3 flex items-center gap-2">
                    <input
                      [(ngModel)]="sourceTag"
                      [disabled]="isSourceTagSaving"
                      class="max-w-[280px]"
                      nz-input
                      placeholder="Source tag"
                      [nzAutocomplete]="sourceTagAutocomplete"
                    />
                    <nz-autocomplete #sourceTagAutocomplete>
                      @for (tag of filteredSourceTags; track tag) {
                        <nz-auto-option [nzValue]="tag">{{ tag }}</nz-auto-option>
                      }
                    </nz-autocomplete>
                    <button
                      (click)="saveSourceTag()"
                      [disabled]="isSourceTagSaving"
                      nz-button
                      nzType="default"
                    >
                      Save tag
                    </button>
                  </div>
                }

                @if (globalSourceComments.length > 0) {
                  <div class="mb-3 grid gap-2">
                    @for (comment of globalSourceComments; track $index) {
                      <nz-card nzSize="small">
                        <div class="text-sm">{{ comment.text }}</div>
                      </nz-card>
                    }
                  </div>
                }

                @if (fileNames.length === 0) {
                  <div nz-typography>No files available for this source.</div>
                } @else {
                  <nz-tabs
                    (nzSelectedIndexChange)="onFileTabChange($event)"
                    [nzSelectedIndex]="selectedFileIndex"
                    nzSize="small"
                  >
                    @for (fileName of fileNames; track fileName) {
                      <nz-tab [nzTitle]="fileName"></nz-tab>
                    }
                  </nz-tabs>

                  @if (selectedFileName) {
                    <app-file-viewer
                      [fileContent]="selectedFileContent"
                      [fileComments]="sourceComments"
                      [fileName]="selectedFileName"
                      [issues]="[]"
                    />
                  }
                }
              }
            </nz-spin>
          }
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<app-source-review-modal
  (isVisibleChange)="isReviewModalVisible = $event"
  (reviewQueued)="handleReviewQueued($event)"
  [isVisible]="isReviewModalVisible"
  [selectedSourcePath]="selectedSourcePath"
/>

<app-job-created-modal
  (isVisibleChange)="isJobModalVisible = $event"
  [isVisible]="isJobModalVisible"
  [jobIds]="jobModalIds"
/>
