<div class="flex flex-col gap-4">
  <nz-card class="ml-[5px] w-full max-w-none rounded-[10px]" nzSize="small">
    <div class="flex items-center justify-between">
      <div>
        <div nz-typography nzType="secondary">Source Viewer</div>
        <div nz-typography>Browse uploaded sources and start reviews.</div>
      </div>

      <button (click)="openReviewModal()"
              nz-button
              nzType="primary"
      >
        Start review
      </button>
    </div>

    @if (errorMessage) {
      <div class="mt-3" nz-typography nzType="danger">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-spin [nzSpinning]="isLoading" nzTip="Loading...">
    <div class="grid grid-cols-[minmax(220px,1fr)_minmax(0,4fr)] gap-4">
      <div>
        <nz-card class="source-tree-container">
          <div nz-typography nzType="secondary">Found sources</div>

          <div class="source-tree-scroll">
            <nz-tree
              (nzClick)="handleSourceNodeClick($event)"
              (nzExpandChange)="handleSourceNodeExpand($event)"
              [nzData]="sourceTreeNodes"
              [nzAsyncData]="true"
              [nzSelectedKeys]="selectedSourceKeys"
              [nzTreeTemplate]="sourceTreeNodeTemplate"
              nzBlockNode
              nzShowLine
            ></nz-tree>
          </div>
          <ng-template #sourceTreeNodeTemplate let-node>
            <span class="inline-flex items-center gap-1">
              <span>{{ node.title }}</span>
              @if (node.origin?.sourceTag) {
                <nz-tag class="text-[10px] leading-none" [nzColor]="sourceTagColor(node.origin?.sourceTag)">{{ node.origin?.sourceTag }}</nz-tag>
              }
            </span>
          </ng-template>
        </nz-card>
      </div>

      <div>
        <nz-card>
          <div>
            <div nz-typography nzType="secondary">Source content</div>
          </div>

          @if (!selectedSourcePath) {
            <div nz-typography>Select prompt from the list to load its content.</div>
          } @else {
            <nz-spin [nzSpinning]="isSourceLoading" nzTip="Loading source...">
              @if (sourceErrorMessage) {
                <div nz-typography nzType="danger">{{ sourceErrorMessage }}</div>
              } @else {

                @if (isAdmin) {
                  <div class="mb-3 flex items-center gap-2">
                    <input
                      [(ngModel)]="sourceTag"
                      [disabled]="isSourceTagSaving"
                      class="max-w-[280px]"
                      nz-input
                      placeholder="Source tag"
                    />
                    <button
                      (click)="saveSourceTag()"
                      [disabled]="isSourceTagSaving"
                      nz-button
                      nzType="default"
                    >
                      Save tag
                    </button>
                  </div>
                }

                @if (fileNames.length === 0) {
                  <div nz-typography>No files available for this source.</div>
                } @else {
                  <nz-tabs
                    (nzSelectedIndexChange)="onFileTabChange($event)"
                    [nzSelectedIndex]="selectedFileIndex"
                    nzSize="small"
                  >
                    @for (fileName of fileNames; track fileName) {
                      <nz-tab [nzTitle]="fileName"></nz-tab>
                    }
                  </nz-tabs>

                  @if (selectedFileName) {
                    <app-file-viewer
                      [fileContent]="selectedFileContent"
                      [fileName]="selectedFileName"
                      [issues]="[]"
                    />
                  }
                }
              }
            </nz-spin>
          }
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<app-source-review-modal
  (isVisibleChange)="isReviewModalVisible = $event"
  (reviewQueued)="handleReviewQueued($event)"
  [isVisible]="isReviewModalVisible"
  [selectedSourcePath]="selectedSourcePath"
/>

<app-job-created-modal
  (isVisibleChange)="isJobModalVisible = $event"
  [isVisible]="isJobModalVisible"
  [jobIds]="jobModalIds"
/>
