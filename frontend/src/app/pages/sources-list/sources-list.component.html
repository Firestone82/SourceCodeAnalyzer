<div class="flex flex-col gap-4">
  <nz-card nzSize="small" class="ml-[5px] w-full max-w-none rounded-[10px]">
    <div class="flex items-center justify-between">
      <div>
        <div nz-typography nzType="secondary">Sources</div>
        <div nz-typography>Browse analyzed source bundles.</div>
      </div>

      <button nz-button
              nzType="primary"
              [disabled]="!selectedSourcePath"
              (click)="openReviewModal()"
      >
        Start review
      </button>
    </div>

    @if (errorMessage) {
      <div nz-typography nzType="danger" class="mt-3">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-spin [nzSpinning]="isLoading" nzTip="Loading...">
    <div class="grid grid-cols-5 gap-4">
      <div class="col-span-1">
        <nz-sider>
          <ul nz-menu nzMode="inline" nzSelectable>
            @for (sourcePath of pagedSourcePaths; track sourcePath) {
              <li nz-menu-item
                  [nzSelected]="sourcePath === selectedSourcePath"
                  (click)="selectSource(sourcePath)"
              >
                <span>{{ sourcePath }}</span>
              </li>
            }
          </ul>

          <div class="mt-3 flex justify-center">
            <nz-pagination
              [nzPageIndex]="pageIndex"
              [nzTotal]="sourcePaths.length"
              [nzPageSize]="pageSize"
              (nzPageIndexChange)="onSourcePageChange($event)"
            />
          </div>
        </nz-sider>
      </div>

      <div class="col-span-4">
        <nz-card>
          @if (!selectedSourcePath) {
            <div nz-typography>Select a source to view its files.</div>
          } @else {
            <nz-spin [nzSpinning]="isSourceLoading" nzTip="Loading source...">
              @if (sourceErrorMessage) {
                <div nz-typography nzType="danger">{{ sourceErrorMessage }}</div>
              } @else {
                @if (fileNames.length === 0) {
                  <div nz-typography>No files available for this source.</div>
                } @else {
                  <div class="mb-3">
                    <nz-select
                      class="w-full"
                      nzPlaceHolder="Select a file"
                      [(ngModel)]="selectedFileName"
                      (ngModelChange)="selectedFileName = $event"
                    >
                      @for (fileName of fileNames; track fileName) {
                        <nz-option [nzLabel]="fileName" [nzValue]="fileName"></nz-option>
                      }
                    </nz-select>
                  </div>

                  @if (selectedFileName) {
                    <app-file-viewer
                      [fileName]="selectedFileName"
                      [fileContent]="selectedFileContent"
                      [issues]="[]"
                    />
                  }
                }
              }
            </nz-spin>
          }
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<app-source-review-modal
  [isVisible]="isReviewModalVisible"
  (isVisibleChange)="isReviewModalVisible = $event"
  [selectedSourcePath]="selectedSourcePath"
  [reviewModel]="reviewModel"
  (reviewModelChange)="reviewModel = $event"
  [promptPaths]="promptPaths"
  [selectedPromptPath]="selectedPromptPath"
  (promptSelectionChange)="selectPromptForReview($event)"
  [promptDraft]="promptDraft"
  (promptDraftChange)="promptDraft = $event"
  [promptErrorMessage]="promptErrorMessage"
  [reviewSubmitError]="reviewSubmitError"
  [isPromptOptionsLoading]="isPromptOptionsLoading"
  [isSubmittingReview]="isSubmittingReview"
  [canSubmitReview]="canSubmitReview"
  (submitReview)="submitReview()"
/>

<app-job-created-modal
  [isVisible]="isJobModalVisible"
  (isVisibleChange)="isJobModalVisible = $event"
  [jobIds]="jobModalIds"
/>
