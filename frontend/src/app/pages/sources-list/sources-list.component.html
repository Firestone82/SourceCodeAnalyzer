<div class="flex flex-col gap-4">
  <nz-card nzSize="small" class="ml-[5px] w-full max-w-none rounded-[10px]">
    <div class="flex items-center justify-between">
      <div>
        <div nz-typography nzType="secondary">Sources</div>
        <div nz-typography>Browse analyzed source bundles.</div>
      </div>

      <button nz-button
              nzType="primary"
              [disabled]="!selectedSourcePath"
              (click)="openReviewModal()"
      >
        Start review
      </button>
    </div>

    @if (errorMessage) {
      <div nz-typography nzType="danger" class="mt-3">{{ errorMessage }}</div>
    }
  </nz-card>

  <nz-spin [nzSpinning]="isLoading" nzTip="Loading...">
    <div class="grid grid-cols-5 gap-4">
      <div class="col-span-1">
        <nz-sider>
          <ul nz-menu nzMode="inline" nzSelectable>
            @for (sourcePath of pagedSourcePaths; track sourcePath) {
              <li nz-menu-item
                  [nzSelected]="sourcePath === selectedSourcePath"
                  (click)="selectSource(sourcePath)"
              >
                <span>{{ sourcePath }}</span>
              </li>
            }
          </ul>

          <div class="mt-3 flex justify-center">
            <nz-pagination
              [nzPageIndex]="pageIndex"
              [nzTotal]="sourcePaths.length"
              [nzPageSize]="pageSize"
              (nzPageIndexChange)="onSourcePageChange($event)"
            />
          </div>
        </nz-sider>
      </div>

      <div class="col-span-4">
        <nz-card>
          @if (!selectedSourcePath) {
            <div nz-typography>Select a source to view its files.</div>
          } @else {
            <nz-spin [nzSpinning]="isSourceLoading" nzTip="Loading source...">
              @if (sourceErrorMessage) {
                <div nz-typography nzType="danger">{{ sourceErrorMessage }}</div>
              } @else {
                @if (fileNames.length === 0) {
                  <div nz-typography>No files available for this source.</div>
                } @else {
                  <div class="mb-3">
                    <nz-select
                      class="w-full"
                      nzPlaceHolder="Select a file"
                      [(ngModel)]="selectedFileName"
                      (ngModelChange)="selectedFileName = $event"
                    >
                      @for (fileName of fileNames; track fileName) {
                        <nz-option [nzLabel]="fileName" [nzValue]="fileName"></nz-option>
                      }
                    </nz-select>
                  </div>

                  @if (selectedFileName) {
                    <app-file-viewer
                      [fileName]="selectedFileName"
                      [fileContent]="selectedFileContent"
                      [issues]="[]"
                    />
                  }
                }
              }
            </nz-spin>
          }
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<nz-modal
  [(nzVisible)]="isReviewModalVisible"
  nzTitle="Process review"
  nzWidth="800px"
  [nzOkDisabled]="!canSubmitReview"
  [nzOkLoading]="isSubmittingReview"
  (nzOnCancel)="closeReviewModal()"
  (nzOnOk)="submitReview()"
>
  <ng-container *nzModalContent>
    <div class="flex flex-col gap-4">
      <div class="rounded border border-slate-200 bg-slate-50 p-3 text-sm">
        <div class="font-semibold">Source</div>
        <div>{{ selectedSourcePath }}</div>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium">Model</label>
        <input nz-input placeholder="Model name" [(ngModel)]="reviewModel"/>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium">Prompt template</label>
        <nz-select
          class="w-full"
          [nzLoading]="isPromptOptionsLoading"
          [ngModel]="selectedPromptPath"
          (ngModelChange)="selectPromptForReview($event)"
          nzPlaceHolder="Select a prompt"
        >
          @for (promptPath of promptPaths; track promptPath) {
            <nz-option [nzLabel]="promptPath" [nzValue]="promptPath"></nz-option>
          }
        </nz-select>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium">Prompt content</label>
        <textarea nz-input
                  rows="25"
                  placeholder="Prompt content"
                  [(ngModel)]="promptDraft"
        ></textarea>
      </div>

      @if (promptErrorMessage) {
        <div nz-typography nzType="danger">{{ promptErrorMessage }}</div>
      }

      @if (reviewSubmitError) {
        <div nz-typography nzType="danger">{{ reviewSubmitError }}</div>
      }

      @if (reviewSubmitMessage) {
        <div nz-typography nzType="success">{{ reviewSubmitMessage }}</div>
      }
    </div>
  </ng-container>
</nz-modal>
